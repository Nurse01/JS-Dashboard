<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- App css -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="style.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <title>Hello World ChartJs</title>
  </head>
  <body>
    <div>
      <div>
        <p class="text-center fs-2">Dashboard</p>
      </div>
      <!--//// CONTENT \\\\-->
      <div class="m-5">
        <div class="row d-flex justify-content-around">
          <!-- OEE part -->
          <div class="box-content border border-white col-sm-3">
            <p id="simple-OEE" class="row p-0 m-0 " ></p>
            <canvas id="contentChart" ></canvas>
          </div>

          <div class="col-sm-3">
            <div class="box-content border border-white m-3 p-2 text-center">
              <p class="fs-3">
                Good Parts <br />
                <span id="sum-good-parts" class="fw-bolder"></span>
              </p>
            </div>
            <div class="box-content border border-white m-3 p-2 text-center">
              <p class="fs-3">
                Total Parts <br />
                <span id="sum-total-parts" class="fw-bolder"></span>
              </p>
            </div>
          </div>
          <div class="box-content border border-white col-sm-3">
            <div>
              <p class="fs-4">
                Total Machines<br /><span id="total-machines" class="px-4"
                  >10 pieces</span
                >
              </p>
            </div>
            <div>
              <p class="fs-4">
                Total Working Machines<br /><span
                  id="total-working-machines"
                  class="px-4"
                ></span>
              </p>
            </div>
            <div>
              <p class="fs-4">
                Total Downtime<br /><span id="total-downtime" class="px-4">
                </span>
              </p>
            </div>
          </div>
        </div>

        <!-- each machine -->
        <div
          id="machines"
          class="row p-0 m-0 d-flex justify-content-around py-3 gap-4"
        ></div>
      </div>
    </div>

    <!-- script -->
    <!-- Socket js -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
      var socket = io();
      let simpleOEE = 0;
      let sumGoodParts = 0;
      let sumTotalParts = 0;
      let sumExpectedQuantity = 0;
      let totalWorkingMachines = 0;
      let totalDowntime = 0;


      socket.on("allMachines", (allMachines) => {
        console.log(allMachines);
        for (let i = 0; i < allMachines.length; i++) {
          //parts scorecard
          sumGoodParts += parseInt(allMachines[i].parts.good_parts);
          sumTotalParts += parseInt(allMachines[i].parts.total_parts);
          totalWorkingMachines = allMachines.length;
          totalDowntime += parseInt(
            allMachines[i].availability.unplanned_downtime
          );
          sumExpectedQuantity += parseInt(
            allMachines[i].parts.expected_quantity
          );
        }
        simpleOEE = ((sumGoodParts / sumExpectedQuantity)*100).toFixed(2);
        document.getElementById("simple-OEE").innerHTML = simpleOEE + " %";
        document.getElementById("sum-good-parts").innerHTML = sumGoodParts;
        document.getElementById("sum-total-parts").innerHTML = sumTotalParts;
        document.getElementById("total-working-machines").innerHTML =
          totalWorkingMachines + " pieces";
        document.getElementById("total-downtime").innerHTML =
          totalDowntime + " minutes";

        // OEE chart
        let myChart = document.getElementById("contentChart").getContext("2d");
        let massPopChart = new Chart(myChart, {
          type: "doughnut",
          data: {
            labels: ["Done", "not done"],
            datasets: [
              {
                data: [80, 20],
                backgroundColor: ["#1d8c51", "#f2e8cf"],
                borderWidth: 1,
                borderColor: "#777",
                hoverBorderWidth: 3,
                hoverBorderColor: "#000",
              },
            ],
          },
          options: {
            title: {
              display: false,
            },
            legend: {
              display: true,
              position: "right",
              labels: {
                fontColor: "#000",
              },
            },
            layout: {
              padding: {
                left: 0,
                right: 0,
                top: 0,
                bottom: 0,
              },
            },
            tooltips: {
              enabled: true,
            },
          },
        });

        // Machine semi-circle
        let html_machines = "";
        for (let i = 0; i < allMachines.length; i++) {
          html_machines += `
                <div class="pointer col-3 p-0 m-0 box-content border border-white text-center" onclick="selectMachine(${allMachines[i].mc_id})" >
                  <p class="fs-3">${allMachines[i].mc_name}
                  <canvas id="${allMachines[i].mc_id}" class=" p-3" ></canvas>
                </div>
                `;
        }
        document.getElementById("machines").innerHTML = html_machines;
        for (let i = 0; i < allMachines.length; i++) {
          let canvasElem = document
            .getElementById(`${allMachines[i].mc_id}`)
            .getContext("2d");
          let semiChart = new Chart(canvasElem, {
            type: "doughnut",
            data: {
              labels: ["total parts", "left parts"],
              datasets: [
                {
                  data: [
                    `${allMachines[i].parts.total_parts}`,
                    `${
                      allMachines[i].parts.expected_quantity -
                      allMachines[i].parts.total_parts
                    }`,
                  ],
                  backgroundColor: ["#40916c", "#fefae0"],
                  borderColor: "#777",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              rotation: -90,
              circumference: 180,
              cutout: "70%",
            },
          });
        }
      });

      function selectMachine(id) {
        let mc_id = id.id;
        window.location.href = `/${mc_id}`;
        window.localStorage.setItem("machineId",mc_id);
        
      }
    </script>
  </body>
</html>

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- App css -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="style.css" />
    <link rel="icon" href="assets/images/dmsicon.ico">
    <title>Dashboard</title>
</head>

<body class="p-5 m-0 ">
    <div class="p-0 m-0">
        <!--1st row -->
        <div class="row p-0 m-0 ">
            <!-- <a href="./dashboard.htmls" class="col-1">
        < Back</a> -->
            <div class="box-content col-4 px-1 text-center">
                <p id="machine-name" class=" fs-2 mx-2 fw-bold "></p>
                <p class="px-4 ">Product : DM234 | line: 3 </p>
            </div>
            <div class="box-content col text-center">
                <p>Status Machine</p>
                <p class="fs-3" id="statusMachine"></p>
            </div>
            <div class="box-content col text-center ">
                <p>Date Time </p>
                <p id="dateTime" class="fs-4"></p>
                </span>
            </div>
            <div class="box-content col text-center">
                <p>Operation Time</p>
                <p id="operationTime" class="fs-3">600 minutes</p>
            </div>

        </div>

        <!-- 2nd row -->
        <div class="row p-0 m-0 text-center ">
            <!-- <div class="box-content col">
        <p>Operation Time</p>
        <p id="operationTime" class="fs-3">600 minutes</p>
      </div> -->
            <div class="box-content col ">
                <p>Total Time</p>
                <p id="totalTime" class="fs-3">1200 minutes</p>
            </div>
            <div id="remainingTime" class="col box-content ">
                <p>Remaining Time</p>
                <p class="fs-3 good-value">300 minutes</p>
            </div>
            <div class="col box-content">
                <p>Production Rate</p>
                <p id="productionRate" class="fs-3">100 parts/minute</p>
            </div>
            <div id="totalStoptime" class="col box-content">
                <p>Total Stoptime</p>
                <p class="fs-3 bad-value">20 minutes</p>
            </div>
        </div>
        <!-- 3rd row -->
        <!-- Key Performance Indicators -->
        <div class="row p-0 m-0 ">
            <!-- OEE -->
            <div class="col-auto box-content" style="width: 437px;">
                <canvas id="oeeChart" width="350" height="350"></canvas>
            </div>
            <div class="col p-0 m-0 align-self-stretch">
                <div class="row p-0 m-0">

                    <!-- Availability -->
                    <!-- <div class="col">
            <div class="">
              <canvas id="availabilityChart"></canvas>
            </div> -->
                    <!-- availability table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Availability</th>
                                    <th id="availability"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Planned Runtime</td>
                                    <td id="planned-runtime"></td>
                                </tr>
                                <tr>
                                    <td>Actual Runtime</td>
                                    <td id="actual-runtime"></td>
                                </tr>
                                <tr>
                                    <td>Unplanned Downtime</td>
                                    <td id="unplanned-downtime"></td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- </div> -->
                    </div>

                    <!-- Performance -->
                    <!-- <div class="col">
            <div>
              <canvas id="performanceChart"></canvas>
            </div> -->
                    <!-- performance table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Performance</th>
                                    <th id="performance"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Planned Quantity</td>
                                    <td id="planned-quantity"></td>
                                </tr>
                                <tr>
                                    <td>Actual Quantity</td>
                                    <td id="actual-quantity"></td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- </div> -->
                    </div>

                    <!-- Quality -->
                    <!-- <div class="col">
            <div>
              <canvas id="quantityChart"></canvas>
            </div> -->
                    <!-- quality table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Quality</th>
                                    <th id="quality"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Actual Quantity</td>
                                    <td id="total-quantity"></td>
                                </tr>
                                <tr>
                                    <td>Reject Quantity</td>
                                    <td id="reject-quantity"></td>
                                </tr>
                            </tbody>
                        </table>
                        <!-- </div> -->

                    </div>

                </div>
                <!-- Status History -->
                <div class="box-content row p-lg-3 p-xl-4" style="height: 200px;">
                    <p class=" text-center">Status History</p>
                    <canvas id="stateChart" width="500" height="30"></canvas>
                </div>
            </div>
        </div>

        <!-- 4th row -->
        <div class="row p-0 ">
            <div class="col">
                <div class="row m-0 text-center">
                    <div id="actual-quantity" class="col box-content">
                        <p>Actual Quantity</p>
                        <p class="fs-3">200 parts</p>
                    </div>

                    <div class="col box-content">
                        <p>Good Parts</p>
                        <p id="good-parts" class="fs-3 good-value"></p>

                    </div>
                    <div class="col box-content">
                        <p>Total Parts </p>
                        <p id="total-parts" class="fs-3"></p>

                    </div>
                    <div class="col box-content">
                        <p>Expected Quantity<br />
                            <p id="expected-quantity" class="fs-3"></p>
                        </p>
                    </div>
                </div>
            </div>




        </div>
    </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="./assets/libs/Chart_2.9.3.js"></script>
    <script src="./assets/libs/Chart_doughnutlabel.js"></script>
    <!-- <script src="./assets/filler_plugin.js"></script> -->
    <script>
        let socket = io();
        let greenColorCode = "#31ce77";
        let redColorCode = "#F83F40";
        let whiteColorCode = "#fff";
        setInterval(myTimer, 1000);

        function myTimer() {
            let dt = new Date();
            let date =
                dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
            document.getElementById("dateTime").innerHTML = date + " " + dt.toLocaleTimeString();
        }

        socket.on("test", (data) => {
            console.log(data);
        });
        let machineId = window.localStorage.getItem("machineId");
        socket.emit("sendMachineId", machineId);

        socket.on("machineDetail", (data) => {
            let machine = data.mcDetail;


            // calculate OEE
            let oee = ((machine.oee.availability / 100) * (machine.oee.performance / 100) * (machine.oee
                .quality / 100) * 100).toFixed(2)

            // Overall
            document.getElementById("machine-name").innerHTML = machine.mc_name;
            document.getElementById("good-parts").innerHTML =
                machine.parts.good_parts;
            document.getElementById("total-parts").innerHTML =
                machine.parts.total_parts;
            // oee
            document.getElementById("availability").innerHTML =
                machine.oee.availability + " %";
            document.getElementById("performance").innerHTML =
                machine.oee.performance + " %";
            document.getElementById("quality").innerHTML =
                machine.oee.quality + " %";
            // Availability
            document.getElementById("planned-runtime").innerHTML =
                machine.availability.planned_runtime + " minute";
            document.getElementById("actual-runtime").innerHTML =
                machine.availability.actual_runtime + " minute";
            document.getElementById("unplanned-downtime").innerHTML =
                machine.availability.unplanned_downtime + " minute";
            // Performance
            document.getElementById("planned-quantity").innerHTML =
                machine.performance.planned_quantity + " parts";
            document.getElementById("actual-quantity").innerHTML =
                machine.performance.actual_quantity + " parts";
            // Quality
            document.getElementById("total-quantity").innerHTML =
                machine.quality.actual_quantity + " parts";
            document.getElementById("reject-quantity").innerHTML =
                machine.quality.reject_quantity + " parts";
            //Detail
            document.getElementById("expected-quantity").innerHTML =
                machine.parts.expected_quantity


            // OEE-doughnut chart
            let dnChart = document.getElementById("oeeChart").getContext("2d");
            let oeeDn = new Chart(dnChart, {
                type: "doughnut",
                data: {
                    datasets: [{
                        label: "OEE",
                        data: [
                            `${oee}`,
                            `${100-oee}`,
                        ],
                        backgroundColor: [`${greenColorCode}`, `${whiteColorCode}`],
                        borderWidth: 1,
                        borderColor: "#777",
                        hoverBorderWidth: 3,
                        hoverBorderColor: "#000",
                    }, ],
                },
                options: {
                    title: {
                        display: true,
                        text: "OEE",
                        fontSize: 25,
                    },
                    legend: {
                        display: true,
                        position: "right",
                    },
                    plugins: {
                        doughnutlabel: {
                            labels: [{
                                text: `${oee} %`,
                                font: {
                                    size: '25',
                                },
                                color: "#fff"
                            }]
                        }
                    }
                }
            });
            //  semi circle chart
            // let scChart = document
            //   .getElementById("semiCircleChart")
            //   .getContext("2d");
            // let semiCirlceChart = new Chart(scChart, {
            //   type: "doughnut",
            //   data: {
            //     datasets: [
            //       {
            //         label: "OEE",
            //         data: [86, 14],
            //         backgroundColor: ["#74c69d", "#f2e8cf"],
            //         borderWidth: 1,
            //         borderColor: "#777",
            //         hoverBorderWidth: 3,
            //         hoverBorderColor: "#000",
            //       },
            //     ],
            //   },
            //   options: {
            //     rotation: -90,
            //     circumference: 180,
            //     cutout: "70%",
            //     title: {
            //       display: false,
            //     },
            //     legend: {
            //       display: true,
            //       position: "right",
            //     },
            //     layout: {
            //       padding: {
            //         left: 50,
            //         right: 0,
            //         top: 0,
            //         bottom: 0,
            //       },
            //     },
            //   },
            // });

            // state history calculation
            let time = data.prodTime;
            let xyValues = [];
            let xyValues2 = [{
                x: (0 - 7) * 3600 * 1000,
                y: 1
            }, {
                x: (24 - 7) * 3600 * 1000,
                y: 1
            }]

            for (let i = 0; i < time.length - 1; i++) {
                let currentTimeStamp = time[i].time_stamp;
                let currentHour = new Date(currentTimeStamp).getHours();
                let currentMinute = new Date(currentTimeStamp).getMinutes();

                let currentTime = currentHour + (currentMinute / 100)
                let currentTimePercent = (currentHour + ((currentTime % 1) * 1.66666666666666667)).toFixed(2)
                console.log(currentTimePercent)

                let nextTimeStamp = time[i + 1].time_stamp;
                let diffHourState = (nextTimeStamp - currentTimeStamp) / 60000 / 60;
                console.log("diffHour " + diffHourState);
                xyValues.push({
                    x: (currentTimePercent - 7) * 3600 * 1000,
                    y: time[i].register_data === 0 ? 1 : 0
                })
                let statusElem = document.getElementById("statusMachine")
                if (time[time.length - 1].register_data === 0) {
                    statusElem.innerHTML = "FAILURE";
                    statusElem.classList.add("bad-bg");
                } else {
                    statusElem.innerHTML = "RUNNING";
                    statusElem.classList.add("good-bg");
                }

            }
            console.log(xyValues)


            Chart.defaults.global.defaultFontColor = 'white';
            let lineChart = document.getElementById("stateChart").getContext("2d");
            let stateLineChart = new Chart(lineChart, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Line Dataset2',
                        data: xyValues,
                        borderWidth: 0,
                        backgroundColor: `${redColorCode}`,
                        fill: true,
                        steppedLine: true,
                        pointRadius: 0,
                    }, {
                        label: 'line Dataset1',
                        data: xyValues2,
                        borderWidth: 0,
                        backgroundColor: `${greenColorCode}`,
                        fill: true,
                        steppedLine: true,
                        pointRadius: 0,
                        type: 'line'
                    }],
                },
                options: {
                    legend: {
                        display: false,
                    },
                    scales: {

                        xAxes: [{
                            type: 'time',
                            ticks: {
                                min: 0 - 7 * 3600 * 1000,
                                max: (24 - 7) * 3600 * 1000
                            },
                        }],
                        yAxes: [{
                            display: false,
                            ticks: {
                                min: 0,
                                max: 1
                            }
                        }],
                    },
                }
            })



            // dont touch this backet
            // let stackedBarChart = document.getElementById("stateChart").getContext("2d");
            // let stateChart = new Chart(stackedBarChart, {
            //     type: 'horizontalBar',
            //     data: {
            //         labels: ['state'],
            //         datasets: [],
            //     },
            //     options: {
            //         legend: {
            //             display: false,
            //         },
            //         scales: {
            //             xAxes: [{
            //                 stacked: true,
            //                 type: 'time',
            //                 time: {
            //                     unit: 'month'
            //                 },

            //             }],
            //             yAxes: [{
            //                 stacked: true

            //             }]
            //         }
            //     }
            // });
        });
    </script>
</body>

</html>
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Title icon -->
    <link rel="icon" href="assets/images/dmsicon.ico">

    <!-- App CSS -->
    <link rel="stylesheet" type="text/css" href="assets/libs/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="assets/libs/css/icons.min.css">
    <link rel="stylesheet" type="text/css" href="assets/libs/css/app.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="style.css" />

    <!-- <link rel="text/css" href="assets/libs/css/materialDesign_6.5.95.css"> -->
    <title>Dashboard</title>
</head>

<body>
    <div class="p-0  m-5">
        <!--1st row -->
        <div class="row p-0 m-0 ">
            <!-- <a href="./dashboard.htmls" class="col-1">
        < Back</a> -->
            <div class="box-content col-4 px-1 text-center">
                <p id="machine-name" class=" fs-2 mx-2 fw-bold "></p>
                <p id="task-name" class="px-4 ">Product : DM234 | line: 3 </p>
            </div>
            <div class="box-content col text-center">
                <p>Status Machine</p>
                <p class="fs-3" id="statusMachine"></p>
            </div>
            <div class="box-content col text-center ">
                <p>Date Time </p>
                <p id="dateTime" class="fs-4"></p>
                </span>
            </div>
            <div class="box-content col text-center">
                <p>Operation Time</p>
                <p id="operation-time" class="fs-3"></p>
            </div>

        </div>

        <!-- 2nd row -->
        <div class="row p-0 m-0 text-center ">
            <!-- <div class="box-content col">
        <p>Operation Time</p>
        <p id="operationTime" class="fs-3">600 minutes</p>
      </div> -->
            <div class="box-content col ">
                <p>Total Time</p>
                <p id="total-time" class="fs-3"></p>
            </div>
            <div class="col box-content ">
                <p>Remaining Time</p>
                <p id="remaining-time" class="fs-3 good-value"></p>
            </div>
            <div class="col box-content">
                <p>Predicted End Time</p>
                <p id="predicted-end-time" class="fs-3"></p>
            </div>
            <div class="col box-content">
                <p>Production Rate</p>
                <p id="production-rate" class="fs-3"></p>
            </div>
            <div class="col box-content">
                <p>Down time</p>
                <p id="total-stop-time" class="fs-3 bad-value"></p>
            </div>
        </div>
        <!-- 3rd row -->
        <!-- Key Performance Indicators -->
        <div class="row p-0 m-0 ">
            <!-- OEE -->
            <div class="col-auto box-content" style="width: 437px;">
                <canvas id="oeeChart" width="350" height="350"></canvas>
            </div>
            <div class="col p-0 m-0 align-self-stretch">
                <div class="row p-0 m-0">

                    <!-- Availability -->

                    <!-- availability table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Availability</th>
                                    <th id="availability"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Planned Runtime</td>
                                    <td id="planned-runtime"></td>
                                </tr>
                                <tr>
                                    <td>Actual Runtime</td>
                                    <td id="actual-runtime"></td>
                                </tr>
                                <tr>
                                    <td>Unplanned Downtime</td>
                                    <td id="unplanned-downtime"></td>
                                </tr>
                            </tbody>
                        </table>

                    </div>

                    <!-- Performance -->
                    <!-- performance table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Performance</th>
                                    <th id="performance"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Planned units</td>
                                    <td id="planned-units"></td>
                                </tr>
                                <tr>
                                    <td>Actual units</td>
                                    <td id="actual-units"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Quality -->
                    <!-- quality table -->
                    <div class="col box-content p-2 p-lg-3 p-xl-4">
                        <table class="table table-bordered">
                            <thead class="thead-light">
                                <tr style="background-color: white; color: #000814;">
                                    <th>Quality</th>
                                    <th id="quality"></th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Actual units</td>
                                    <td id="total-units"></td>
                                </tr>
                                <tr>
                                    <td>Scrap units</td>
                                    <td id="reject-units"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Status History -->
                <div class="box-content row p-lg-3 p-xl-4" style="height: 200px;">
                    <p class=" text-center">Status History</p>
                    <canvas id="stateChart" width="500" height="30"></canvas>
                </div>
            </div>
        </div>

        <!-- 4th row -->
        <div class="row p-0 ">
            <div class="col">
                <div class="row m-0 text-center">
                    <div class="col box-content">
                        <p>Target<br />
                            <p id="target-units" class="fs-3"></p>
                        </p>
                    </div>
                    <div class="col box-content">
                        <p>Current</p>
                        <p id="current-units" class="fs-3 good-value"></p>

                    </div>
                    <div class="col box-content">
                        <p>Actual
                            <span class="tooltip-test" title="The units should be" data-bs-placement="right"><i
                                    class="mdi mdi-information-outline"></i></span>
                        </p>

                        <p id="actual" class="fs-3"></p>
                    </div>
                    <div class="col box-content">
                        <p>Difference</p>
                        <p id="diff-units" class="fs-3"></p>

                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- <button type="button" class="btn btn-secondary" data-bs-toggle="tooltip" data-bs-placement="right" title="Tooltip on right">
        Tooltip on right
      </button> -->
    </div>
    <!-- Insert this line above script imports  -->
    <script>
        if (typeof module === 'object') {
            window.module = module;
            module = undefined;
        }
    </script>
    <!-- Vendor js -->
    <script src="assets/libs/js/vendor.min.js"></script>

    <!-- Chart js -->
    <script src="assets/libs/js/chart.bundle.min.js"></script>

    <!-- App js -->
    <script src="assets/libs/js/app.min.js"></script>
    <!-- Socket js -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="assets/libs/js/chart_2.9.3.js"></script>
    <script src="assets/libs/js/chart_doughnutlabel.js"></script>

    <script src="assets/libs/js/numeral.min.js"></script>
    <!--validation -->
    <!-- <script src="./assets/libs/parsley.js"></script>
    <script src="./assets/libs/formValidation.init.js"></script> -->
    <!-- popper -->
    <!-- <script src="assets/libs/js/popper.min.js"></script> -->
    <!-- <script src="./assets/filler_plugin.js"></script> -->
    <script>
        let socket = io();
        let greenColorCode = "#31ce77";
        let redColorCode = "#F83F40";
        let whiteColorCode = "#fff";
        let dateTime = '';
        let totalTime = 0;
        let remainingTime = 0;
        let totalStopTime = 0;
        let operationTime = 0;
        let productionRate = 100; // units/min
        let actualUnits = 0;
        let diffUnits = 0;
        let idealCycleTime = 0;
        // oee
        let availability = 0;
        let performance = 0;
        let quality = 0;
        let oee = 0;


        socket.on("test", (data) => {
            console.log(data);
        });
        let machineId = window.localStorage.getItem("machineId");
        socket.emit("sendMachineId", machineId);

        socket.on("machineDetail", (data) => {
            let machine = data.mcDetail;

            function myTimer() {
                let dt = new Date();
                dateTime =
                    dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
                document.getElementById("dateTime").innerHTML = dateTime + " " + dt.toLocaleTimeString();
                // Perdicted end time

                idealCycleTime = productionRate / 60; //min per units
                let remainingUnits = machine.units.target_units - machine.units.current_units;
                let predEndMillisec = (idealCycleTime * remainingUnits) * 60000;
                let currentTime = new Date();
                let predEndTime = new Date(currentTime.getTime() + predEndMillisec);

                document.getElementById("predicted-end-time").innerHTML = predEndTime.getFullYear() + "-" + (
                        predEndTime.getMonth() + 1) + "-" + predEndTime.getDate() + " " + predEndTime
                    .toLocaleTimeString();

            }
            setInterval(myTimer, 1000);

            // diffUnits
            function calDiffUnits() {
                actualUnits = productionRate * operationTime;
                diffUnits = machine.quality.actual_units - machine.units.current_units;
                console.log(diffUnits)

                let textArray = String(diffUnits).split('');
                let sign = textArray[0];
                let newText = '';

                if (sign == '-') {
                    textArray.shift()
                    newText = textArray.join('')

                    document.getElementById("diff-units").innerHTML =
                        `<i class="mdi mdi-arrow-down mdi-rotate-180 good-value"></i>${newText} units`
                } else {
                    newText = textArray.join('')
                    document.getElementById("diff-units").innerHTML =
                        `<i class="mdi mdi-arrow-down bad-value"></i>${newText} units`
                }

            }
            calDiffUnits();
            document.getElementById("operation-time").innerHTML = numeral(operationTime).format('0,0') +
                " minutes";
            document.getElementById("total-time").innerHTML = numeral(totalTime).format('0,0') + " minutes";
            document.getElementById("remaining-time").innerHTML = numeral(remainingTime).format('0,0') +
                " minutes";
            document.getElementById("production-rate").innerHTML = productionRate + " units / minute"
            document.getElementById("total-stop-time").innerHTML = numeral(totalStopTime).format('0,0') +
                " minutes";
            document.getElementById("actual").innerHTML = numeral(machine.performance.actual_units).format(
                '0,0') + " units";

            function calOEE() {
                // calculate avalibility = runtime / planned prod time

                // calculate performance = (ideal cycle time * total count)/run time

                // calculate quality = good count / total count

                // calculate OEE
                oee = ((machine.oee.availability / 100) * (machine.oee.performance / 100) * (machine.oee
                    .quality / 100) * 100).toFixed(2)

            }
            calOEE();

            // Overall
            document.getElementById("machine-name").innerHTML = machine.mc_name;
            document.getElementById("current-units").innerHTML =
                numeral(machine.units.current_units).format('0,0') + " units";
            // oee
            document.getElementById("availability").innerHTML =
                machine.oee.availability + " %";
            document.getElementById("performance").innerHTML =
                machine.oee.performance + " %";
            document.getElementById("quality").innerHTML =
                machine.oee.quality + " %";
            // Availability
            document.getElementById("planned-runtime").innerHTML =
                numeral(machine.availability.planned_runtime).format('0,0') + " minute";
            document.getElementById("actual-runtime").innerHTML =
                numeral(machine.availability.actual_runtime).format('0,0') + " minute";
            document.getElementById("unplanned-downtime").innerHTML =
                numeral(machine.availability.unplanned_downtime).format('0,0') + " minute";
            // Performance
            document.getElementById("planned-units").innerHTML =
                numeral(machine.performance.planned_units).format('0,0') + " units";
            document.getElementById("actual-units").innerHTML =
                numeral(machine.performance.actual_units).format('0,0') + " units";
            // Quality
            document.getElementById("total-units").innerHTML =
                numeral(machine.quality.actual_units).format('0,0') + " units";
            document.getElementById("reject-units").innerHTML =
                numeral(machine.quality.reject_units).format('0,0') + " units";
            //Detail
            document.getElementById("target-units").innerHTML =
                numeral(machine.units.target_units).format('0,0') + " units";



            // OEE-doughnut chart
            let dnChart = document.getElementById("oeeChart").getContext("2d");
            let oeeDn = new Chart(dnChart, {
                type: "doughnut",
                data: {
                    datasets: [{
                        label: "OEE",
                        data: [
                            `${oee}`, `${100 - oee}`,
                        ],
                        backgroundColor: [`${greenColorCode}`, `${whiteColorCode}`],
                        borderWidth: 1,
                        borderColor: "#777",
                        hoverBorderWidth: 3,
                        hoverBorderColor: "#000",
                    }, ],
                },
                options: {
                    title: {
                        display: true,
                        text: "OEE",
                        fontSize: 25,
                    },
                    legend: {
                        display: true,
                        position: "right",
                    },
                    plugins: {
                        doughnutlabel: {
                            labels: [{
                                text: `${oee} % `,
                                font: {
                                    size: '25',
                                },
                                color: "#fff"
                            }]
                        }
                    }
                }
            });
            //  semi circle chart
            // let scChart = document
            //   .getElementById("semiCircleChart")
            //   .getContext("2d");
            // let semiCirlceChart = new Chart(scChart, {
            //   type: "doughnut",
            //   data: {
            //     datasets: [
            //       {
            //         label: "OEE",
            //         data: [86, 14],
            //         backgroundColor: ["#74c69d", "#f2e8cf"],
            //         borderWidth: 1,
            //         borderColor: "#777",
            //         hoverBorderWidth: 3,
            //         hoverBorderColor: "#000",
            //       },
            //     ],
            //   },
            //   options: {
            //     rotation: -90,
            //     circumference: 180,
            //     cutout: "70%",
            //     title: {
            //       display: false,
            //     },
            //     legend: {
            //       display: true,
            //       position: "right",
            //     },
            //     layout: {
            //       padding: {
            //         left: 50,
            //         right: 0,
            //         top: 0,
            //         bottom: 0,
            //       },
            //     },
            //   },
            // });

            // state history calculation
            let time = data.prodTime;
            let xyValues = [];
            let xyValues2 = [{
                x: (0 - 7) * 3600 * 1000,
                y: 1
            }, {
                x: (24 - 7) * 3600 * 1000,
                y: 1
            }]

            for (let i = 0; i < time.length - 1; i++) {
                let currentTimeStamp = time[i].time_stamp;
                let currentHour = new Date(currentTimeStamp).getHours();
                let currentMinute = new Date(currentTimeStamp).getMinutes();

                let currentTime = currentHour + (currentMinute / 100)
                let currentTimePercent = (currentHour + ((currentTime % 1) * 1.66666666666666667)).toFixed(2)
                    // console.log(currentTimePercent)

                let nextTimeStamp = time[i + 1].time_stamp;
                let diffHourState = (nextTimeStamp - currentTimeStamp) / 60000 / 60;
                // console.log("diffHour " + diffHourState);
                xyValues.push({
                    x: (currentTimePercent - 7) * 3600 * 1000,
                    y: time[i].register_data === 0 ? 1 : 0
                })
                let statusElem = document.getElementById("statusMachine")
                if (time[time.length - 1].register_data === 0) {
                    statusElem.innerHTML = "FAILURE";
                    statusElem.classList.add("bad-bg");
                } else {
                    statusElem.innerHTML = "RUNNING";
                    statusElem.classList.add("good-bg");
                }

            }
            // console.log(xyValues)


            Chart.defaults.global.defaultFontColor = 'white';
            let lineChart = document.getElementById("stateChart").getContext("2d");
            let stateLineChart = new Chart(lineChart, {
                type: 'line',
                data: {
                    datasets: [{
                        label: 'Line Dataset2',
                        data: xyValues,
                        borderWidth: 0,
                        backgroundColor: `${redColorCode}`,
                        fill: true,
                        steppedLine: true,
                        pointRadius: 0,
                    }, {
                        label: 'line Dataset1',
                        data: xyValues2,
                        borderWidth: 0,
                        backgroundColor: `${greenColorCode} `,
                        fill: true,
                        steppedLine: true,
                        pointRadius: 0,
                        type: 'line'
                    }],
                },
                options: {
                    legend: {
                        display: false,
                    },
                    scales: {

                        xAxes: [{
                            type: 'time',
                            ticks: {
                                min: 0 - 7 * 3600 * 1000,
                                max: (24 - 7) * 3600 * 1000
                            },
                        }],
                        yAxes: [{
                            display: false,
                            ticks: {
                                min: 0,
                                max: 1
                            }
                        }],
                    },
                }
            })

            // dont touch this backet
        });
    </script>
</body>

</html>
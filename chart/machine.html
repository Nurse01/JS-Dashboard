<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- App css -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>


  <link rel="stylesheet" href="style.css" />
  <title>Hello World ChartJs</title>
</head>

<body class="p-4 m-0 ">
  <div class="p-0 m-0">
    <!--Detail -->
    <div class="row p-0 m-0 ">
      <!-- <a href="./dashboard.htmls" class="col-1">
        < Back</a> -->
      <p id="machine-name" class="box-content fs-1 col-4 p-2 "></p>
      <div id="statusMachine" class="box-content col  text-center">
        <p>Status Machine</p>
        <p class="fs-3" style="background-color:#74c69d;">RUNNING</p>
      </div>
      <div class="box-content col text-center ">
        <p>Date</p>
        <p id="date" class="fs-3"></p>
      </div>
      <div class="box-content col text-center">
        <p>Time</p>
        <p id="time" class="fs-3"></p>
      </div>
    </div>

    <!-- Key Performance Indicators -->
    <div class="row p-0 m-0 ">
      <!-- OEE -->
      <div class="col-xl-3 col-md-2 col-1 my-auto p-1 box-content">
        <canvas id="oeeChart"></canvas>
      </div>
      <div class="col p-0 m-0">
        <div class="row p-0 m-0">

          <!-- Availability -->
          <!-- <div class="col">
            <div class="">
              <canvas id="availabilityChart"></canvas>
            </div> -->
          <!-- availability table -->
          <div class="col box-content p-2 p-lg-3 p-xl-4">
            <table class="table table-bordered">
              <thead class="thead-light">
                <tr style="background-color: white; color: #000814;">
                  <th>Availability</th>
                  <th id="availability"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Planned Runtime</td>
                  <td id="planned-runtime"></td>
                </tr>
                <tr>
                  <td>Actual Runtime</td>
                  <td id="actual-runtime"></td>
                </tr>
                <tr>
                  <td>Unplanned Downtime</td>
                  <td id="unplanned-downtime"></td>
                </tr>
              </tbody>
            </table>
            <!-- </div> -->
          </div>

          <!-- Performance -->
          <!-- <div class="col">
            <div>
              <canvas id="performanceChart"></canvas>
            </div> -->
          <!-- performance table -->
          <div class="col box-content p-2 p-lg-3 p-xl-4">
            <table class="table table-bordered">
              <thead class="thead-light">
                <tr style="background-color: white; color: #000814;">
                  <th>Performance</th>
                  <th id="performance"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Planned Quantity</td>
                  <td id="planned-quantity"></td>
                </tr>
                <tr>
                  <td>Actual Quantity</td>
                  <td id="actual-quantity"></td>
                </tr>
              </tbody>
            </table>
            <!-- </div> -->
          </div>

          <!-- Quality -->
          <!-- <div class="col">
            <div>
              <canvas id="quantityChart"></canvas>
            </div> -->
          <!-- quality table -->
          <div class="col box-content p-2 p-lg-3 p-xl-4">
            <table class="table table-bordered">
              <thead class="thead-light">
                <tr style="background-color: white; color: #000814;">
                  <th>Quality</th>
                  <th id="quality"></th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>Actual Quantity</td>
                  <td id="total-quantity"></td>
                </tr>
                <tr>
                  <td>Reject Quantity</td>
                  <td id="reject-quantity"></td>
                </tr>
              </tbody>
            </table>
            <!-- </div> -->

          </div>

        </div>
        <!-- Product Quantity  -->
        <div class=" box-content row p-2 p-lg-3 p-xl-4">
          <canvas id="quantityBarChart" style="max-height: 150px"></canvas>
        </div>
      </div>
    </div>
    <div class="row p-0 ">
      <div class="col">
        <div class="row m-0 text-center">
          <div id="operationTime" class="col box-content  ">
            <p>Operation Time</p>
            <p class="fs-3" style="color:#74c69d;">300 minutes</p>
          </div>
          <div id="totalStoptime" class="col box-content  ">
            <p>Total Stoptime</p>
            <p class="fs-3" style="color:#e01e37;">20 minutes</p>
          </div>
          <div class="col box-content">
            <p>
              Good Parts <br />
              <span id="good-parts" class="fs-3" style="color: #74c69d;"></span>
            </p>
          </div>
          <div class="col box-content">
            <p>
              Total Parts <br />
              <span id="total-parts" class="fs-3"></span>
            </p>
          </div>
          <div class="col box-content">
            <p>
              Expected Quantity<br />
              <span id="expected-quantity" class="fs-3" style="color: #74c69d;"></span>
            </p>
          </div>
        </div>
      </div>


      <!-- Production Rate -->
      <!-- <div class="col-4 p-3 mb-3 box-content border border-white">
          <p class="col-12 fs-3 mx-2">Production Rate</p>
          <canvas id="semiCircleChart" style="max-height: 150px"></canvas>
        </div>
      </div> -->

    </div>
    <!-- Machine Log -->
    <div class="box-content col-5">
      <p>Machine Log</p>
    </div>
    <script src="/socket.io/socket.io.js"></script>
    <!-- <script src="./assets/Chart.bundle.min.js"></script> -->
    <script>
      const plugin = {
        beforeDraw: function (chart) {
          if (chart.config.options.elements.center) {
            //Get ctx from string
            var ctx = chart.chart.ctx;

            //Get options from the center object in options
            var centerConfig = chart.config.options.elements.center;
            var fontStyle = centerConfig.fontStyle || "Arial";
            var txt = centerConfig.text;
            var color = centerConfig.color || "#000";
            var sidePadding = centerConfig.sidePadding || 20;
            var sidePaddingCalculated =
              (sidePadding / 100) * (chart.innerRadius * 2);
            //Start with a base font of 30px
            ctx.font = "50px " + fontStyle;

            //Get the width of the string and also the width of the element minus 10 to give it 5px side padding
            var stringWidth = ctx.measureText(txt).width;
            var elementWidth = chart.innerRadius * 2 - sidePaddingCalculated;

            // Find out how much the font can grow in width.
            var widthRatio = elementWidth / stringWidth;
            var newFontSize = Math.floor(30 * widthRatio);
            var elementHeight = chart.innerRadius * 2;

            // Pick a new font size so it will not be larger than the height of label.
            var fontSizeToUse = Math.min(newFontSize, elementHeight);

            //Set font settings to draw it correctly.
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";
            var centerX = (chart.chartArea.left + chart.chartArea.right) / 2;
            var centerY = (chart.chartArea.top + chart.chartArea.bottom) / 2;
            ctx.font = fontSizeToUse + "px " + fontStyle;
            ctx.fillStyle = color;

            //Draw text in center
            ctx.fillText(txt, centerX, centerY);
          }
        },
        // Important for showing all label values, but looks very bad
        beforeRender: function (chart) {
          // if (chart.config.options.showAllTooltips) {
          //   // create an array of tooltips
          //   // we can't use the chart tooltip because there is only one tooltip per chart
          //   chart.pluginTooltips = [];
          //   chart.config.data.datasets.forEach(function(dataset, i) {
          //     chart.getDatasetMeta(i).data.forEach(function(sector, j) {
          //       chart.pluginTooltips.push(
          //         new Chart.Tooltip(
          //           {
          //             _chart: chart.chart,
          //             _chartInstance: chart,
          //             _data: chart.data,
          //             _options: chart.options.tooltips,
          //             _active: [sector]
          //           },
          //           chart
          //         )
          //       );
          //     });
          //   });
          //   // turn off normal tooltips
          //   chart.options.tooltips.enabled = false;
          // }
        },
        // Important for showing all label values, but looks very bad
        afterDraw: function (chart, easing) {
          // if (chart.config.options.showAllTooltips) {
          //   // we don't want the permanent tooltips to animate, so don't do anything till the animation runs atleast once
          //   if (!chart.allTooltipsOnce) {
          //     if (easing !== 1) return;
          //     chart.allTooltipsOnce = true;
          //   }
          //   // turn on tooltips
          //   chart.options.tooltips.enabled = true;
          //   Chart.helpers.each(chart.pluginTooltips, function(tooltip) {
          //     tooltip.initialize();
          //     tooltip._options.bodyFontFamily = "'Lato', sans-serif"
          //     tooltip._options.displayColors = false;
          //     tooltip._options.bodyFontSize = tooltip._chart.height * 0.06;
          //     tooltip._options.yPadding = 0;
          //     tooltip._options.xPadding = 0;
          //     // tooltip._options.position = 'average';
          //     // tooltip._options.caretSize = tooltip._options.bodyFontSize * 0.5;
          //     //tooltip._options.cornerRadius = tooltip._options.bodyFontSize * 0.5;
          //     tooltip.update();
          //     // we don't actually need this since we are not animating tooltips
          //     tooltip.pivot();
          //     tooltip.transition(easing).draw();
          //   });
          //   chart.options.tooltips.enabled = false;
          // }
        },
      };

      let socket = io();
      setInterval(myTimer, 1000);

      function myTimer() {
        let dt = new Date();
        let date =
          dt.getFullYear() + "-" + (dt.getMonth() + 1) + "-" + dt.getDate();
        document.getElementById("date").innerHTML = date;
        document.getElementById("time").innerHTML = dt.toLocaleTimeString();
      }

      socket.on("test", (data) => {
        console.log(data);
      });


      let machineId = window.localStorage.getItem("machineId");
      socket.emit("sendMachineId", machineId);

      socket.on("machineDetail", (data) => {
        let machine = data;

        // Overall
        document.getElementById("machine-name").innerHTML = machine.mc_name;
        document.getElementById("good-parts").innerHTML =
          machine.parts.good_parts;
        document.getElementById("total-parts").innerHTML =
          machine.parts.total_parts;
        // oee
        document.getElementById("availability").innerHTML =
          machine.oee.availability + " %";
        document.getElementById("performance").innerHTML =
          machine.oee.performance + " %";
        document.getElementById("quality").innerHTML =
          machine.oee.quality + " %";
        // Availability
        document.getElementById("planned-runtime").innerHTML =
          machine.availability.planned_runtime + " minute";
        document.getElementById("actual-runtime").innerHTML =
          machine.availability.actual_runtime + " minute";
        document.getElementById("unplanned-downtime").innerHTML =
          machine.availability.unplanned_downtime + " minute";
        // Performance
        document.getElementById("planned-quantity").innerHTML =
          machine.performance.planned_quantity + " parts";
        document.getElementById("actual-quantity").innerHTML =
          machine.performance.actual_quantity + " parts";
        // Quality
        document.getElementById("total-quantity").innerHTML =
          machine.quality.actual_quantity + " parts";
        document.getElementById("reject-quantity").innerHTML =
          machine.quality.reject_quantity + " parts";

        // horizontal bar chart
        let qtChart = document
          .getElementById("quantityBarChart")
          .getContext("2d");
        //           var mixedChart = new Chart(qtChart, {
        //   type: 'bar',
        //   data: {
        //     datasets: [{
        //           label: 'Bar Dataset',
        //           data: [10, 20, 30, 40]
        //         }, {
        //           label: 'Line Dataset',
        //           data: [50, 50, 50, 50],

        //           // Changes this dataset to become a line
        //           type: 'line'
        //         }],
        //     labels: ['January', 'February', 'March', 'April']
        //   }
        // });

        let quantitybarChart = new Chart(qtChart, {
          data: {
            labels: ["", "Product Quantity", ""],
            datasets: [{
                type: "bar",
                label: "quantity",
                axis: "x",
                data: [0, `${machine.parts.total_parts}`, 0],
                fill: false,
                backgroundColor: "#74c69d",
                borderColor: "#777",
                borderWidth: 1,
              },
              {
                type: "line",
                label: "Expected Quantity",
                data: [
                  `${machine.parts.expected_quantity}`,
                  `${machine.parts.expected_quantity}`,
                  `${machine.parts.expected_quantity}`,
                ],
                fill: false,
                borderColor: "rgb(54, 162, 235)",
                pointStyle: "circle",
              },
            ],
          },
          options: {
            color: "#f2e8cf",
            indexAxis: "y",
            // labels:{
            //   fontColor : "#f2e8cf",
            // }
          },
          plugins: `${plugin}`
        });

        // OEE-doughnut chart
        let dnChart = document.getElementById("oeeChart").getContext("2d");
        let oeeDn = new Chart(dnChart, {
          type: "doughnut",
          data: {
            datasets: [{
              label: "OEE",
              data: [86, 14],
              backgroundColor: ["#74c69d", "#f2e8cf"],
              borderWidth: 1,
              borderColor: "#777",
              hoverBorderWidth: 3,
              hoverBorderColor: "#000",
            }, ],
          },
          options: {
            title: {
              display: true,
              text: "OEE",
              fontSize: 25,
            },
            legend: {
              display: true,
              position: "right",
            },
            layout: {
              padding: {
                left: 0,
                right: 0,
                top: 0,
                bottom: 0,
              },
            },
            elements: {
              center: {
                text: String("25.00" + "\n%"), // .replace(/\n/g, "<br />")
                color: "#ffffff",
                fontStyle: "Helvetica",
                fontSize: 5,
                sidePadding: 0, //Default 20 (as a percentage)
              },
            },
          },
        });

        //  semi circle chart
        //   let scChart = document
        //     .getElementById("semiCircleChart")
        //     .getContext("2d");
        //   let semiCirlceChart = new Chart(scChart, {
        //     type: "doughnut",
        //     data: {
        //       datasets: [
        //         {
        //           label: "OEE",
        //           data: [86, 14],
        //           backgroundColor: ["#74c69d", "#f2e8cf"],
        //           borderWidth: 1,
        //           borderColor: "#777",
        //           hoverBorderWidth: 3,
        //           hoverBorderColor: "#000",
        //         },
        //       ],
        //     },
        //     options: {
        //       rotation: -90,
        //       circumference: 180,
        //       cutout: "70%",
        //       title: {
        //         display: false,
        //       },
        //       legend: {
        //         display: true,
        //         position: "right",
        //       },
        //       layout: {
        //         padding: {
        //           left: 50,
        //           right: 0,
        //           top: 0,
        //           bottom: 0,
        //         },
        //       },
        //     },
        //   });
      });
    </script>
</body>

</html>